<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<html>
<head>
	{% block title %}<title>Home Page</title>{% endblock %}
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
	<meta http-equiv="Pragma" content="no-cache"/>
	<meta http-equiv="Expires" content="0"/>
	{% load static %}
	<link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon"/>
	<link rel="stylesheet" href="{% static 'css/styles.css' %}">
	<link rel="stylesheet" href="{% static 'css/jquery.fullPage.css' %}">
	<link rel="stylesheet" href="{% static 'css/jquery-ui.min.css' %}">
	<link rel="stylesheet" href="{% static 'css/jquery-ui.structure.min.css' %}">
	<link rel="stylesheet" href="{% static 'css/jquery-ui.theme.min.css' %}">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<style>
		#section1.load-background{
			background:url({% static 'images/bg1.jpg' %}) no-repeat center center;
		}
		#section2.load-background{
			background:url({% static 'images/bg2.jpg' %}) no-repeat center center;
		}
		#section3.load-background{
			background:url({% static 'images/bg3.jpg' %}) no-repeat center center;
		}
	</style>
	<script type="text/javascript" src="{% static 'js/jquery.min.js' %}"></script>
	<script type="text/javascript" src="{% static 'js/jquery-ui.min.js' %}"></script>
	<script type="text/javascript" src="{% static 'js/jquery.fullPage.js' %}"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			var pagesTitle = ["Home Page", "What can I do?", "Page number 3", "Page number 4"];
			var diet_not_loaded = true;
			var md_cover = false;
			var user_filter_text = false;
			var sort_by = "sort_by_name";
			var page_number = 0;
			var search_results_count = 0;
			var filter_mapping_dict = {
				"search_filter": "#md-panel-search",
				"diet_filter": "#md-panel-diet",
				"prep_time_filter": "#md-panel-prep",
				"ingredient_filter": "#md-panel-ingredient"
			};
			$("#noscript").attr("style","display: none;"),
			$("#fullpage").fullpage({
				verticalCentered: false,
				css3: false,
				menu: "#menu",
				anchors: ["Home", "WhatCanIDo", "3rdPage", "4thPage"],
				sectionsColor: ["#F0F2F4", "#fff", "#fff", "#fff"],
				navigation: true,
				navigationPosition: "right",
				navigationTooltips: pagesTitle,
				responsiveWidth: 900,
				afterLoad: function(anchorLink, index) {
					if (index == 4 && diet_not_loaded) {
						$.ajax({
							url: "/api/get_diets/",
							dataType: "json",
							success: function(data) {
								if (data.status == 200) {
									var diets = $("#md-container-diets");
									var prep_from = $("#PrepFrom");
									diets.empty();
									prep_from.empty();
									diets.append("<div class=\"filter_menu_item keyingredient_selected\" value=\"any\" style=\"cursor: pointer\">any&nbsp;<span class=\"small_text\">-  Any diet</span></div>");
									$("#selected_diet").text("any");
									for (var i = 0; i < data.message.list.length; ++i) {
										diets.append("<div class=\"filter_menu_item\" value=\"" + data.message.list[i].name + "\" style=\"cursor: pointer\">" + data.message.list[i].name + "&nbsp;<span class=\"small_text\">-  " + data.message.list[i].desc + "</span></div>");
									}
									prep_from.append("<option id=\"0\" value=\"0\">Any duration</option>");
									for (var i = 1; i < 18; ++i) {
										prep_from.append("<option id=\"" + i*10 + "\" value=\"" + i*10 + "\">" + int2duration(i*10) + "</option>");
									}
									prep_from.append("<option id=\"180\" value=\"180\">More then 3 hours</option>");
									$("#md-panel-search .md-panel").css("left", ($("#search_filter").position().left+390) + "px");
									$("#md-panel-diet .md-panel").css("left", ($("#diet_filter").position().left+390) + "px");
									$("#md-panel-prep .md-panel").css("left", ($("#prep_time_filter").position().left+390) + "px");
									diet_not_loaded = false;
									prep_from.change();
									getRecipes();
								}
							}
						});

					}
					document.title = pagesTitle[index-1];
				},
				onLeave: function(index, nextIndex, direction) {
					if (index == 2 && direction == "down") {
						$(".section").eq(index -1).removeClass("moveDown").addClass("moveUp");
					} else if (index == 2 && direction == "up") {
						$(".section").eq(index -1).removeClass("moveUp").addClass("moveDown");
					}
					// Lazy load bg
					var destinationSection = $(".section").eq(nextIndex-1);
					destinationSection.addClass("load-background");
				},
				afterResponsive: function(isResponsive) {
					
				}
			});
			$("#moveToHome").click(function(e) {
				e.preventDefault();
				$.fn.fullpage.moveTo(1);
			});
			$("#moveToPage2").click(function(e) {
				e.preventDefault();
				$.fn.fullpage.moveTo(2);
			});
			$("#moveToPage3").click(function(e) {
				e.preventDefault();
				$.fn.fullpage.moveTo(3);
			});
			$("#moveToPage4").click(function(e) {
				e.preventDefault();
				$.fn.fullpage.moveTo(4);
			});
			$(".sort_button").click(function(e) {
				$(".sort_button").removeClass("sort_selected");
				$(this).addClass("sort_selected");
				if (sort_by != $(this)[0].id) {
					$("#"+sort_by).find("i").removeClass("fa-chevron-circle-down");
					$("#"+sort_by).find("i").removeClass("fa-chevron-circle-up");
					sort_by = $(this)[0].id;
				}
				if ($(this).find("i").hasClass("fa-chevron-circle-down")) {
					$(this).find("i").removeClass("fa-chevron-circle-down").addClass("fa-chevron-circle-up");
				} else {
					$(this).find("i").removeClass("fa-chevron-circle-up").addClass("fa-chevron-circle-down");
				}
			});
			$("#md-cover").click(function(e) {
				$(".md-panel-outer-wrapper").removeClass("_md-panel-shown").addClass("_md-panel-hidden");
				md_cover = false;
			});
			$(".md-ok").click(function(e) {
				$(".md-panel-outer-wrapper").removeClass("_md-panel-shown").addClass("_md-panel-hidden");
				md_cover = false;
			});
			$(".filter_option").click(function(e) {
				if (md_cover == true) {
					$(".md-panel-outer-wrapper").removeClass("_md-panel-shown").addClass("_md-panel-hidden");
				}
				$("#md-cover").removeClass("_md-panel-hidden").addClass("_md-panel-shown");
				$(filter_mapping_dict[$(this)[0].id]).removeClass("_md-panel-hidden").addClass("_md-panel-shown");
				md_cover = true;
			});
			$("#page_prev").click(function(e) {
				if (page_number == Math.ceil(search_results_count/6)) {
					$("#page_next").removeClass("pagination_hidden")
				}
				if (0 < page_number) {
					page_number -= 1;
					getRecipes();
				}
				if (page_number == 0) {
					$("#page_prev").addClass("pagination_hidden")
				}
			});
			$("#page_next").click(function(e) {
				if (page_number == 0) {
					$("#page_prev").removeClass("pagination_hidden")
				}
				if (page_number < Math.ceil(search_results_count/6)) {
					page_number += 1;
					getRecipes();
				}
				if (page_number == Math.ceil(search_results_count/6)) {
					$("#page_next").addClass("pagination_hidden")
				}
			});
			$("#md-panel-diet").on("click", ".filter_menu_item", function(e) {
				e.stopPropagation();
				e.stopImmediatePropagation();
				$(this).parent().find(".filter_menu_item").removeClass("keyingredient_selected");
				$(this).addClass("keyingredient_selected");
				$("#selected_diet").text($(this).attr("value"));
				$("#md-panel-prep .md-panel").css("left", ($("#prep_time_filter").position().left+390) + "px");
				$("#md-panel-ingredient .md-panel").css("left", ($("#ingredient_filter").position().left+390) + "px");
			});
			$("#PrepFrom").change(function () {
				var prep_from = $(this).find(":selected")[0].id;
				var prep_to = $("#PrepTo");
				prep_to.empty();
				if (prep_from == 0) {
					prep_to.append("<option id=\"0\" value=\"0\">Any duration</option>");
				}
				for (var i = 1; i < 18; ++i) {
					if (prep_from <= i*10) {
						prep_to.append("<option id=\"" + i*10 + "\" value=\"" + i*10 + "\">" + int2duration(i*10) + "</option>");
					}
				}
				prep_to.append("<option id=\"180\" value=\"180\" selected>More then 3 hours</option>");
				$("#selected_prep").text($(this).find(":selected")[0].text + " - " + $("#PrepTo").find(":selected")[0].text);
				$("#md-panel-ingredient .md-panel").css("left", ($("#ingredient_filter").position().left+390) + "px");
			});
			$("#PrepTo").change(function () {
				$("#selected_prep").text($(this).find(":selected")[0].text + " - " + $("#PrepTo").find(":selected")[0].text);
				$("#md-panel-ingredient .md-panel").css("left", ($("#ingredient_filter").position().left+390) + "px");
			});
			$("#apiGetRecipesSuggestion").on('input', function() {
				if (user_filter_text == true && $(this).val() == "") {
					$("#search_filter .fa").removeClass("fa-search-plus").addClass("fa-search");
					$("#search_filter .fa").css("color", "");
					user_filter_text = false;
				} else if (user_filter_text == false && $(this).val() != "") {
					$("#search_filter .fa").removeClass("fa-search").addClass("fa-search-plus");
					$("#search_filter .fa").css("color", "red");
					user_filter_text = true;
				}
			});
			$("#apiGetRecipesSuggestion").autocomplete({
				source: function(request, response) {
					$.ajax({
						url: "/api/get_recipes_suggestion/",
						dataType: "json",
						data: {q: request.term},
						success: function(data) {
							if (data.status == 200) {
								response($.map(data.message.suggestions, function(item) {
									return {
										label: item.name + " - " + item.calories + " Calories",
										value: item.name
									};
								}));
							}
						}
					});
				},
				minLength: 3,
				open: function() {$(this).removeClass("ui-corner-all").addClass("ui-corner-top");},
				close: function() {$(this).removeClass("ui-corner-top").addClass("ui-corner-all");}
			});
			$(".apiGetingredientsSuggestion").autocomplete({
				source: function(request, response) {
					$.ajax({
						url: "/api/get_ingredients_suggestion/",
						dataType: "json",
						data: {q: request.term},
						success: function(data) {
							if (data.status == 200) {
								response($.map(data.message.suggestions, function(item) {
									return {
										label: item.name,
										value: item.name
									};
								}));
							}
						}
					});
				},
				change: function (e, ui) {
					if (!ui.item) {
						$(this).val("");
					}
				},
				minLength: 2,
				open: function() {$(this).removeClass("ui-corner-all").addClass("ui-corner-top");},
				close: function() {$(this).removeClass("ui-corner-top").addClass("ui-corner-all");}
			});
			function int2duration(num) {
				if (num < 60) {
					return num + " Minutes";
				} else if (num == 60) {
					return "1 Hour";
				} else if (num < 120) {
					return "1 Hour " + (num-60) + " Minutes";
				} else if (num == 120) {
					return "2 Hours";
				} else {
					return "2 Hours " + (num-120) + " Minutes";
				}
			}
			function getRecipes() {
				var recipe_name = $("#apiGetRecipesSuggestion").val();
				var diet = $("#md-container-diets .keyingredient_selected").attr("value");
				var prep_from = $("#PrepFrom").find(":selected")[0].id;
				var prep_to = $("#PrepTo").find(":selected")[0].id;
				var ingredients_inc = [];
				var ingredients_exc = [];
				for (var i = 1; i < 6; ++i) {
					if ($("#ingredientsInc" + i).val() != "") {
						ingredients_inc.push($("#ingredientsInc" + i).val());
					}
					if ($("#ingredientsExc" + i).val() != "") {
						ingredients_exc.push($("#ingredientsExc" + i).val());
					}
				}
				ingredients_inc = [...new Set(ingredients_inc)];
				ingredients_exc = [...new Set(ingredients_exc)];
				var sort_by = $("#bottom_row_content .sort_selected")[0].id;
				var sort_order;
				if ($("#"+sort_by).find("i").hasClass("fa-chevron-circle-down")) {
					sort_order = "desc";
				} else {
					sort_order = "asc";
				}
				$.ajax({
					url: "/api/search_recipes/",
					dataType: "json",
					data:  {recipe_name: recipe_name,
						diet: diet,
						prep_from: prep_from,
						prep_to: prep_to,
						ingredients_inc: ingredients_inc.join("+"),
						ingredients_exc: ingredients_exc.join("+"),
						sort_by: sort_by,
						sort_order: sort_order,
						page: page_number},
					success: function(data) {
						if (data.status == 200) {
							var loop_prep_array;
							var loop_prep_hours;
							var loop_prep_minutes;
							$("#recipes").empty();
							for (var i = 0; i < data.message.items.length; ++i) {
								loop_prep_array = data.message.items[i].prep_time.split(":", 3);
								if (loop_prep_array[0] == "01") {
									loop_prep_hours = "1 hour";
								} else if (loop_prep_array[0] != "00") {
									loop_prep_hours = parseInt(loop_prep_array[0]) + " hours";
								} else {
									loop_prep_hours = "";
								}
								if (loop_prep_array[1] != "00") {
									loop_prep_minutes = " " + parseInt(loop_prep_array[1]) + " Minutes";
								} else {
									loop_prep_minutes = "";
								}
								$("#recipes").append("\
							<div class=\"each_recipe_parent\" id=\"recipe_n_" + data.message.items[i].id + "\">\
								<div class=\"each_recipe\">\
									<a target=\"_blank\" href=\"" + data.message.items[i].url + "\">\
										<div class=\"recipe\" style=\"background-image: url('" + data.message.items[i].image + "');\">\
											<div class=\"recipe-info\">\
												<div class=\"recipe-title\">" + data.message.items[i].name + "</div>\
												<div class=\"recipe-info-footer\">\
													<span>" + loop_prep_hours + loop_prep_minutes + ", " + parseInt(data.message.items[i].calories).toLocaleString() + " Calories</span>\
												</div>\
											</div>\
										</div>\
									</a>\
								</div>\
							</div>");
								search_results_count = parseInt(data.message.results);
								$("#page_status").text("Showing results " + ((page_number*6)+1) + "-" + ((page_number+1)*6) + " out of " + search_results_count.toLocaleString());
							}
						}
					}
				});
			}
		});
	</script>
</head>
<body>
<div id="noscript">
<div><strong>Warning: </strong>For full functionality of this site it is necessary to enable JavaScript.<br/>Here are the <a href="http://www.enable-javascript.com/" target="_blank"> instructions how to enable JavaScript in your web browser</a>.</div>
</div>
<div id="header">FoodFinder
	<ul id="menu">
		<li data-menuanchor="Home" class="active"><a id="moveToHome" href="#">Home Page</a></li>
		<li data-menuanchor="WhatCanIDo"><a id="moveToPage2" href="#">What can I do?</a></li>
		<li data-menuanchor="3rdPage"><a id="moveToPage3" href="#">Page number 3</a></li>
		<li data-menuanchor="4thPage"><a id="moveToPage4" href="#">Page number 4</a></li>
	</ul>
</div>
<div id="footer">The site was build as a the final project at Tel Aviv University Database Systems (Fall 2018/19) course (0368-3458).</div>
<div id="fullpage">
	<div class="section" id="section0" style="background:url({% static 'images/bg0.jpg' %}) no-repeat center center;">
		<div class="wrap">
			<div class="box fp-auto-height-responsive">
				<h1>FoodFinder</h1>
				A new and innovative way to find the best restaurant that <strong>fits</strong> you.<br/>
				Here you can find recipes by ingredient count, preparation time and diet..<br/>
				Ready? <a href="#WhatCanIDo">let's find you somewhere to eat</a>
			</div>
		</div>
	</div>
	<div class="section moveDown" id="section1">
		<div class="wrap">
			<div class="imgsContainer">
				<img src="{% static 'images/image0.jpg' %}" alt="Plate Left" id="plate_left"/>
				<img src="{% static 'images/image1.jpg' %}" alt="Plate Middle" id="plate_middle"/>
				<img src="{% static 'images/image2.png' %}" alt="Plate Right" id="plate_right"/>
			</div>
			<div class="box fp-auto-height-responsive">
				<h2>What Can I Do?</h2>
				<strong>Lorem ipsum</strong> dolor sit amet, consectetur <a href="#3rdPage">adipiscing elit</a>.
				Quisque eget dolor et leo porttitor <a href="#4thPage">consectetur id sit</a>.
			</div>
		</div>
	</div>
	<div class="section" id="section2">
		<div class="wrap">
			<div class="box fp-auto-height-responsive">
				<h2>Lorem ipsum dolor sit amet.</h2>
				 <strong>Lorem ipsum</strong> dolor sit amet, consectetur adipiscing elit. Suspendisse iaculis,
				 dolor non imperdiet vulputate, lorem dui posuere ipsum, nec tincidunt nunc tellus ultrices orci.
				 Donec vel luctus ipsum. Proin a venenatis leo, eget blandit.
			</div>
		</div>
	</div>
	<div class="section moveDown" id="section3">
		<div class="wrap">
			<div class="box fp-auto-height-responsive">
				<h2>Lorem ipsum dolor sit amet.</h2>
				<div class="filter_chip_container">
					<div class="filter_row">
						<div class="filter_option" id="search_filter"><i class="fa fa-search" aria-hidden="true"></i></div>
						<div class="filter_option" id="diet_filter">Diet <span id="selected_diet" class="small_text"></span></div>
						<div class="filter_option" id="prep_time_filter">Meal preparation time <span id="selected_prep" class="small_text"></span></div>
						<div class="filter_option" id="ingredient_filter">Ingredient</div>
					</div>
				</div>
				<div class="row clearfix" id="recipes-content-container">
					<div class="recipes-container">
						<div id="recipes" class="clearfix">
						</div>
					</div>
				</div>
				<div class="filter_chip_container">
					<div class="filter_row" id="bottom_row_content">
						<div class="filter_menu_item">Sort by</div>
						<div class="filter_menu_item sort_button sort_selected" id="sort_by_name">Recipe name&nbsp;<i class="fa fa-chevron-circle-down"></i></div>
						<div class="filter_menu_item sort_button" id="sort_by_prep">Preparation time&nbsp;<i class="fa"></i></div>
						<div class="filter_menu_item sort_button" id="sort_by_cal">Calories&nbsp;<i class="fa"></i></div>
						<div class="filter_menu_item" style="flex-grow: 1"></div>
						<div class="filter_menu_item pagination_hidden" id="page_prev">Previous</div>
						<div class="filter_menu_item" id="page_status">Showing results ?-? out of ?</div>
						<div class="filter_menu_item" id="page_next">Next</div>
					</div>
				</div>
				<div class="md-panel-outer-wrapper _md-panel-hidden" id="md-cover">
					<div class="md-panel _md-panel-backdrop _md-opaque-enter"></div>
				</div>
				<div class="md-panel-outer-wrapper _md-panel-hidden" id="md-panel-search"> 
					<div class="_md-panel-focus-trap"></div>
					<div class="md-panel" style="left: 400px;">
						<div class="keyingredient_menu filter_menu">
							<h6 class="md-subhead" style="min-width: 224px">Select recipe by name</h6>
							<hr width="90%">
							<div class="filter_menu_item">
								<input type="text" name="recipesSearch" id="apiGetRecipesSuggestion" class="ui-corner-all"/>
							</div>
						</div>
						<div class="md-ok"><button class="md-button" type="button" style="width: 100%;padding: 10px;">Confirm</button></div>
					</div>
					<div class="_md-panel-focus-trap"></div>
				</div>
				<div class="md-panel-outer-wrapper _md-panel-hidden" id="md-panel-diet"> 
					<div class="_md-panel-focus-trap"></div>
					<div class="md-panel" style="left: 450px;">
						<div class="keyingredient_menu filter_menu">
							<h6 class="md-subhead" style="min-width: 224px">Select diet</h6>
							<hr width="90%">
							<div id="md-container-diets">
								<div class="filter_menu_item" value="invalid">~~ Waiting for data ~~<span class="small_text"></span></div>
							</div>
						</div>
						<div class="md-ok"><button class="md-button" type="button" style="width: 100%;padding: 10px;">Confirm</button></div>
					</div>
					<div class="_md-panel-focus-trap"></div>
				</div>
				<div class="md-panel-outer-wrapper _md-panel-hidden" id="md-panel-prep"> 
					<div class="_md-panel-focus-trap"></div>
					<div class="md-panel" style="left: 560px;">
						<div class="keyingredient_menu filter_menu">
							<h6 class="md-subhead" style="min-width: 224px">Preparation time</h6>
							<hr width="90%">
							<div class="filter_menu_item">
								Between&nbsp;
								<select name="PrepFrom" id="PrepFrom">
									<option id="invalid" value="invalid">~~ Waiting for data ~~</option>
								</select>
							</div>
							<div class="filter_menu_item">
								To&nbsp;
								<select name="PrepTo" id="PrepTo">
									<option id="invalid" value="invalid">~~ Waiting for data ~~</option>
								</select>
							</div>
						</div>
						<div class="md-ok"><button class="md-button" type="button" style="width: 100%;padding: 10px;">Confirm</button></div>
					</div>
					<div class="_md-panel-focus-trap"></div>
				</div>
				<div class="md-panel-outer-wrapper _md-panel-hidden" id="md-panel-ingredient"> 
					<div class="_md-panel-focus-trap"></div>
					<div class="md-panel" style="left: 880px;">
						<div class="keyingredient_menu filter_menu">
							<h6 class="md-subhead" style="min-width: 224px">Filter by ingredients</h6>
							<hr width="90%">
							<div class="filter_menu_item">Include</div>
							<div class="filter_menu_item"><input type="text" id="ingredientsInc1" class="apiGetingredientsSuggestion ui-corner-all"/></div>
							<div class="filter_menu_item"><input type="text" id="ingredientsInc2" class="apiGetingredientsSuggestion ui-corner-all"/></div>
							<div class="filter_menu_item"><input type="text" id="ingredientsInc3" class="apiGetingredientsSuggestion ui-corner-all"/></div>
							<div class="filter_menu_item"><input type="text" id="ingredientsInc4" class="apiGetingredientsSuggestion ui-corner-all"/></div>
							<div class="filter_menu_item"><input type="text" id="ingredientsInc5" class="apiGetingredientsSuggestion ui-corner-all"/></div>
							<div class="filter_menu_item">Exclude</div>
							<div class="filter_menu_item"><input type="text" id="ingredientsExc1" class="apiGetingredientsSuggestion ui-corner-all"/></div>
							<div class="filter_menu_item"><input type="text" id="ingredientsExc2" class="apiGetingredientsSuggestion ui-corner-all"/></div>
							<div class="filter_menu_item"><input type="text" id="ingredientsExc3" class="apiGetingredientsSuggestion ui-corner-all"/></div>
							<div class="filter_menu_item"><input type="text" id="ingredientsExc4" class="apiGetingredientsSuggestion ui-corner-all"/></div>
							<div class="filter_menu_item"><input type="text" id="ingredientsExc5" class="apiGetingredientsSuggestion ui-corner-all"/></div>
						</div>
						<div class="md-ok"><button class="md-button" type="button" style="width: 100%;padding: 10px;">Confirm</button></div>
					</div>
					<div class="_md-panel-focus-trap"></div>
				</div>
			</div>
		</div>
	</div>
</div>
</body>
</html>
